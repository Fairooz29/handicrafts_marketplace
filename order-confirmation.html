<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Order Confirmation | Crafts of Bengal</title>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin />
  <link href="https://fonts.googleapis.com/css2?display=swap&family=Noto+Sans:wght@400;500;700;900&family=Plus+Jakarta+Sans:wght@400;500;700;800" rel="stylesheet" />

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />

  <!-- Custom CSS -->
  <link rel="stylesheet" href="assets/css/style.css" />
  
  <!-- JavaScript -->
  <script src="assets/js/main.js" defer></script>
  <script src="assets/js/auth-check.js" defer></script>
</head>
<body>
  <div class="main-container">
    <div class="page-card">
      <!-- Header -->
      <header class="header">
        <div class="logo-title">
          <div class="logo-icon"></div>
          <h2 class="site-title">Crafts of Bengal</h2>
        </div>
        <nav class="nav-links">
          <a href="index.html">Home</a>
          <a href="handicrafts.html">Shop</a>
          <a href="artisans.html">Artisans</a>
          <a href="about.html">About</a>
          <a href="contact.html">Contact</a>
        </nav>
        <div class="header-actions">
          <form class="search-bar" action="handicrafts.html" method="get">
            <input type="text" name="search" placeholder="Search" aria-label="Search for handicrafts, artisans, or categories" />
            <button type="submit" aria-label="Search">
              <span class="icon-search"></span>
            </button>
          </form>
          <a href="favorites.html" class="icon-btn" aria-label="Favorites">
            <span class="icon-heart"></span>
          </a>
          <a href="cart.html" class="icon-btn" aria-label="Cart">
            <span class="icon-cart"></span>
          </a>
        </div>
        <a href="profile.html" class="profile-avatar-link">
          <img src="assets/images/profile.jpg" alt="Profile" class="profile-avatar" />
        </a>
      </header>

      <!-- Main Content -->
      <main class="confirmation-main">
        <div class="confirmation-container">
          <!-- Success Header -->
          <div class="confirmation-header">
            <div class="success-icon">
              <i class="fas fa-check-circle"></i>
            </div>
            <h1 class="confirmation-title">Order Confirmed!</h1>
            <p class="confirmation-subtitle">Thank you for your order. We'll send you a confirmation email shortly.</p>
          </div>

          <!-- Order Details -->
          <div class="order-details-card">
            <div class="order-header">
              <h2><i class="fas fa-receipt"></i> Order Details</h2>
              <div class="order-status pending">
                <i class="fas fa-clock"></i>
                <span>Processing</span>
              </div>
            </div>

            <div class="order-info-grid">
              <div class="info-item">
                <span class="label">Order Number</span>
                <span class="value" id="orderNumber">Loading...</span>
              </div>
              <div class="info-item">
                <span class="label">Order Date</span>
                <span class="value" id="orderDate">Loading...</span>
              </div>
              <div class="info-item">
                <span class="label">Payment Method</span>
                <span class="value" id="paymentMethod">Loading...</span>
              </div>
              <div class="info-item">
                <span class="label">Estimated Delivery</span>
                <span class="value" id="estimatedDelivery">Loading...</span>
              </div>
            </div>
          </div>

          <!-- Order Items -->
          <div class="order-items-card">
            <h3><i class="fas fa-box"></i> Order Items</h3>
            <div class="items-list" id="orderItems">
              <div class="loading-message">Loading order items...</div>
            </div>
          </div>

          <!-- Shipping & Billing -->
          <div class="address-cards">
            <div class="address-card">
              <h3><i class="fas fa-truck"></i> Shipping Address</h3>
              <div class="address-content" id="shippingAddress">
                <div class="loading-message">Loading shipping address...</div>
              </div>
            </div>
            
            <div class="address-card">
              <h3><i class="fas fa-file-invoice"></i> Order Summary</h3>
              <div class="order-summary-content" id="orderSummary">
                <div class="loading-message">Loading order summary...</div>
              </div>
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="confirmation-actions">
            <button class="action-btn primary" onclick="window.location.href='profile.html?tab=orders'">
              <i class="fas fa-list"></i>
              View All Orders
            </button>
            <button class="action-btn secondary" onclick="window.location.href='handicrafts.html'">
              <i class="fas fa-shopping-bag"></i>
              Continue Shopping
            </button>
            <button class="action-btn secondary" onclick="window.print()">
              <i class="fas fa-print"></i>
              Print Receipt
            </button>
          </div>

          <!-- Support Section -->
          <div class="support-section">
            <h3><i class="fas fa-headset"></i> Need Help?</h3>
            <p>If you have any questions about your order, please don't hesitate to contact us.</p>
            <div class="support-options">
              <a href="contact.html" class="support-link">
                <i class="fas fa-envelope"></i>
                Contact Support
              </a>
              <a href="tel:+8801700000000" class="support-link">
                <i class="fas fa-phone"></i>
                Call Us
              </a>
              <a href="#" class="support-link" onclick="startLiveChat()">
                <i class="fas fa-comments"></i>
                Live Chat
              </a>
            </div>
          </div>
        </div>
      </main>

      <!-- Footer -->
      <footer class="footer">
        <nav class="footer-links">
          <a href="about.html">About</a>
          <a href="contact.html">Contact</a>
          <a href="privacy-policy.html">Privacy Policy</a>
          <a href="terms.html">Terms of Service</a>
        </nav>
        <p class="footer-text">@2024 Crafts of Bengal. All rights reserved.</p>
      </footer>
    </div>
  </div>

  <script>
    // Order confirmation page functionality
    document.addEventListener('DOMContentLoaded', function() {
      loadOrderConfirmation();
    });

    async function loadOrderConfirmation() {
      try {
        // Get order number from URL parameter
        const urlParams = new URLSearchParams(window.location.search);
        const orderNumber = urlParams.get('order');
        
        if (!orderNumber) {
          // Try to get order from localStorage
          const lastOrder = localStorage.getItem('last_order');
          if (lastOrder) {
            const orderData = JSON.parse(lastOrder);
            displayOrderDetailsFromLocalStorage(orderData);
          } else {
            window.location.href = 'index.html';
          }
          return;
        }

        // Try to fetch order details from API
        try {
          const response = await fetch(`api/orders.php?order_id=${orderNumber}`);
          const data = await response.json();
          
          if (data.success && data.data) {
            displayOrderDetailsFromAPI(data.data);
          } else {
            // If API fails, try localStorage
            const lastOrder = localStorage.getItem('last_order');
            if (lastOrder) {
              const orderData = JSON.parse(lastOrder);
              if (orderData.order_number === orderNumber) {
                displayOrderDetailsFromLocalStorage(orderData);
              } else {
                showError();
              }
            } else {
              showError();
            }
          }
        } catch (error) {
          console.error('API error:', error);
          // If API fails, try localStorage
          const lastOrder = localStorage.getItem('last_order');
          if (lastOrder) {
            const orderData = JSON.parse(lastOrder);
            if (orderData.order_number === orderNumber) {
              displayOrderDetailsFromLocalStorage(orderData);
            } else {
              showError();
            }
          } else {
            showError();
          }
        }
        
      } catch (error) {
        console.error('Error loading order confirmation:', error);
        showError();
      }
    }

    function displayOrderDetailsFromAPI(orderData) {
      // Update order number
      document.getElementById('orderNumber').textContent = orderData.order_number;
      
      // Update order date
      const orderDate = new Date(orderData.created_at);
      document.getElementById('orderDate').textContent = orderDate.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
      
      // Update payment method
      document.getElementById('paymentMethod').textContent = formatPaymentMethod(orderData.payment_method);
      
      // Calculate estimated delivery based on shipping method
      const deliveryDays = getDeliveryDays(orderData.shipping_method);
      const deliveryDate = new Date(orderDate);
      deliveryDate.setDate(deliveryDate.getDate() + deliveryDays);
      
      document.getElementById('estimatedDelivery').textContent = deliveryDate.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
      
      // Display order items
      displayOrderItemsFromAPI(orderData.items);
      
      // Display shipping address
      displayShippingAddressFromAPI(orderData.shipping_address);
      
      // Display order summary
      displayOrderSummaryFromAPI(orderData);
    }

    function displayOrderDetailsFromLocalStorage(orderData) {
      // Update order number
      document.getElementById('orderNumber').textContent = orderData.order_number;
      
      // Update order date
      const orderDate = new Date(orderData.order_date);
      document.getElementById('orderDate').textContent = orderDate.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
      
      // Update payment method
      document.getElementById('paymentMethod').textContent = formatPaymentMethod(orderData.payment_method);
      
      // Calculate estimated delivery based on shipping method
      const deliveryDays = getDeliveryDays(orderData.shipping_method);
      const deliveryDate = new Date(orderDate);
      deliveryDate.setDate(deliveryDate.getDate() + deliveryDays);
      
      document.getElementById('estimatedDelivery').textContent = deliveryDate.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
      
      // Display order items
      displayOrderItemsFromLocalStorage(orderData.order_items);
      
      // Display shipping address
      displayShippingAddressFromLocalStorage(orderData.shipping_address);
      
      // Display order summary
      displayOrderSummaryFromLocalStorage(orderData);
    }

    function formatPaymentMethod(method) {
      switch(method) {
        case 'card': return 'Credit/Debit Card';
        case 'mobile': return 'Mobile Banking';
        case 'cash': return 'Cash on Delivery';
        default: return method;
      }
    }

    function getDeliveryDays(shippingMethod) {
      switch(shippingMethod) {
        case 'express': return 3;
        case 'overnight': return 1;
        default: return 7; // standard
      }
    }

    function formatCurrency(amount) {
      return 'à§³' + parseFloat(amount).toLocaleString('en-US', { minimumFractionDigits: 0 });
    }

    function displayOrderItemsFromAPI(items) {
      const itemsContainer = document.getElementById('orderItems');
      
      if (!items || items.length === 0) {
        itemsContainer.innerHTML = '<p>No items in this order.</p>';
        return;
      }
      
      itemsContainer.innerHTML = items.map(item => `
        <div class="order-item">
          <img src="${item.image_url || 'assets/images/placeholder.jpg'}" alt="${item.name}" class="item-image">
          <div class="item-details">
            <h4 class="item-name">${item.name}</h4>
            <p class="item-artisan">by ${item.artisan_name || 'Artisan'}</p>
            <p class="item-quantity">Quantity: ${item.quantity}</p>
          </div>
          <div class="item-price">${formatCurrency(item.price * item.quantity)}</div>
        </div>
      `).join('');
    }

    function displayOrderItemsFromLocalStorage(items) {
      const itemsContainer = document.getElementById('orderItems');
      
      if (!items || items.length === 0) {
        itemsContainer.innerHTML = '<p>No items in this order.</p>';
        return;
      }
      
      itemsContainer.innerHTML = items.map(item => {
        const itemTotal = item.price * item.quantity;
        const imageUrl = item.image_url || item.image || 'assets/images/placeholder.jpg';
        const artisanName = item.artisan_name || item.artisan || 'Artisan';
        
        return `
          <div class="order-item">
            <img src="${imageUrl}" alt="${item.name}" class="item-image">
            <div class="item-details">
              <h4 class="item-name">${item.name}</h4>
              <p class="item-artisan">by ${artisanName}</p>
              <p class="item-quantity">Quantity: ${item.quantity}</p>
            </div>
            <div class="item-price">${formatCurrency(itemTotal)}</div>
          </div>
        `;
      }).join('');
    }

    function displayShippingAddressFromAPI(addressString) {
      const shippingContainer = document.getElementById('shippingAddress');
      
      if (!addressString) {
        shippingContainer.innerHTML = '<p>No shipping address available.</p>';
        return;
      }
      
      // Parse address parts
      const addressParts = addressString.split(', ');
      const name = addressParts[0] || 'Customer';
      
      shippingContainer.innerHTML = `
        <div class="address-details">
          <p><strong>${name}</strong></p>
          <p>${addressString}</p>
        </div>
      `;
    }

    function displayShippingAddressFromLocalStorage(address) {
      const shippingContainer = document.getElementById('shippingAddress');
      
      if (!address) {
        shippingContainer.innerHTML = '<p>No shipping address available.</p>';
        return;
      }
      
      const fullName = `${address.first_name} ${address.last_name}`;
      const addressLine1 = address.address;
      const addressLine2 = address.apartment ? address.apartment : '';
      const cityRegion = `${address.city}, ${address.division} ${address.postal_code}`;
      
      shippingContainer.innerHTML = `
        <div class="address-details">
          <p><strong>${fullName}</strong></p>
          <p>${addressLine1}</p>
          ${addressLine2 ? `<p>${addressLine2}</p>` : ''}
          <p>${cityRegion}</p>
          <p>Bangladesh</p>
        </div>
      `;
    }

    function displayOrderSummaryFromAPI(orderData) {
      const summaryContainer = document.getElementById('orderSummary');
      
      summaryContainer.innerHTML = `
        <div class="summary-row">
          <span>Subtotal</span>
          <span>${formatCurrency(orderData.subtotal)}</span>
        </div>
        <div class="summary-row">
          <span>Shipping</span>
          <span>${formatCurrency(orderData.shipping_cost)}</span>
        </div>
        <div class="summary-row">
          <span>Tax</span>
          <span>${formatCurrency(orderData.tax_amount)}</span>
        </div>
        <div class="summary-row total">
          <span>Total</span>
          <span>${formatCurrency(orderData.total_amount)}</span>
        </div>
      `;
    }

    function displayOrderSummaryFromLocalStorage(orderData) {
      const summaryContainer = document.getElementById('orderSummary');
      
      if (orderData.order_summary) {
        const summary = orderData.order_summary;
        
        summaryContainer.innerHTML = `
          <div class="summary-row">
            <span>Subtotal</span>
            <span>${formatCurrency(summary.subtotal)}</span>
          </div>
          <div class="summary-row">
            <span>Shipping</span>
            <span>${formatCurrency(summary.shipping_cost)}</span>
          </div>
          <div class="summary-row">
            <span>Tax</span>
            <span>${formatCurrency(summary.tax)}</span>
          </div>
          <div class="summary-row total">
            <span>Total</span>
            <span>${formatCurrency(summary.total)}</span>
          </div>
        `;
      } else if (orderData.total_amount) {
        summaryContainer.innerHTML = `
          <div class="summary-row total">
            <span>Total</span>
            <span>${formatCurrency(orderData.total_amount)}</span>
          </div>
        `;
      } else {
        summaryContainer.innerHTML = '<p>Order summary not available.</p>';
      }
    }

    function showError() {
      document.querySelector('.confirmation-container').innerHTML = `
        <div class="error-message">
          <div class="error-icon">
            <i class="fas fa-exclamation-triangle"></i>
          </div>
          <h2>Unable to Load Order</h2>
          <p>We couldn't find your order details. Please check your email for confirmation or contact support.</p>
          <div class="error-actions">
            <button class="action-btn primary" onclick="window.location.href='profile.html?tab=orders'">
              View Orders
            </button>
            <button class="action-btn secondary" onclick="window.location.href='contact.html'">
              Contact Support
            </button>
          </div>
        </div>
      `;
    }

    function startLiveChat() {
      alert('Live chat feature coming soon! Please contact us via email or phone for immediate assistance.');
    }
  </script>
</body>
</html>

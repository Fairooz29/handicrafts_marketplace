<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Your Cart | Crafts of Bengal</title>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin />
  <link href="https://fonts.googleapis.com/css2?display=swap&family=Noto+Sans:wght@400;500;700;900&family=Plus+Jakarta+Sans:wght@400;500;700;800" rel="stylesheet" />

  <!-- Custom CSS -->
  <link rel="stylesheet" href="assets/css/style.css" />
  
  <!-- Scripts -->
  <script src="assets/js/main.js" defer></script>
  <script src="assets/js/auth-check.js" defer></script>
</head>
<body>
  <div class="main-container">
    <div class="page-card">
      <!-- Header -->
      <header class="header">
        <div class="logo-title">
          <div class="logo-icon"></div>
          <h2 class="site-title">Crafts of Bengal</h2>
        </div>
        <nav class="nav-links">
          <a href="index.html">Home</a>
          <a href="handicrafts.html">Shop</a>
          <a href="artisans.html">Artisans</a>
          <a href="about.html">About</a>
          <a href="contact.html">Contact</a>
        </nav>
        <div class="header-actions">
          <form class="search-bar" action="handicrafts.html" method="get">
            <input type="text" name="search" placeholder="Search" aria-label="Search for handicrafts, artisans, or categories" />
            <button type="submit" aria-label="Search">
              <span class="icon-search"></span>
            </button>
          </form>
          <a href="favorites.html" class="icon-btn" aria-label="Favorites">
            <span class="icon-heart"></span>
          </a>
          <a href="cart.html" class="icon-btn" aria-label="Cart">
            <span class="icon-cart"></span>
          </a>
        </div>

      </header>

      <!-- Main Content -->
      <main style="flex:1;">
        <section style="max-width:900px;margin:0 auto;padding:2rem 0;">
          <nav style="font-size:0.98rem;color:#8a7c6d;margin-bottom:1.5rem;">
            <a href="index.html" style="color:#8a7c6d;">Home</a> /
            <a href="cart.html" style="color:#8a7c6d;">Cart</a>
          </nav>
          <h1 class="section-title" style="padding-bottom:1.5rem;">Your Cart</h1>
          
          <!-- Cart Content -->
          <div id="cartContent" style="display:flex;flex-wrap:wrap;gap:2rem;align-items:flex-start;">
            <!-- Cart Items -->
            <div style="flex:2;min-width:320px;">
              <div id="cartItems" class="cart-items">
                <!-- Cart items will be loaded here dynamically -->
                <div class="cart-loading">Loading cart items...</div>
              </div>
            </div>

            <!-- Order Summary -->
            <div id="orderSummary" class="order-summary" style="flex:1;min-width:220px;background:#faf9f7;padding:1.5rem 1.2rem;border-radius:1rem;box-shadow:0 2px 8px rgba(0,0,0,0.04);">
              <div style="font-weight:700;font-size:1.1rem;margin-bottom:1rem;">Order Summary</div>
              <div style="display:flex;justify-content:space-between;margin-bottom:0.5rem;font-size:1.01rem;">
                <span>Subtotal</span>
                <span id="subtotal">৳0</span>
              </div>
              <div style="display:flex;justify-content:space-between;margin-bottom:0.5rem;font-size:1.01rem;">
                <span>Shipping</span>
                <span id="shipping">৳0</span>
              </div>
              <div style="display:flex;justify-content:space-between;margin-bottom:0.5rem;font-size:1.01rem;">
                <span>Tax</span>
                <span id="tax">৳0</span>
              </div>
              <div style="display:flex;justify-content:space-between;font-weight:700;font-size:1.12rem;margin:1rem 0 1.5rem 0;">
                <span>Total</span>
                <span id="total">৳0</span>
              </div>
              <button id="checkoutButton" onclick="proceedToCheckout()" style="width:100%;background:#ed7b2a;color:#fff;font-weight:700;font-size:1.08rem;padding:0.9rem 0;border:none;border-radius:0.5rem;cursor:pointer;" disabled>
                Proceed to Checkout
              </button>
            </div>
          </div>

          <!-- Empty Cart Message -->
          <div id="emptyCartMessage" style="display:none;text-align:center;padding:3rem 1rem;">
            <h2 style="font-size:1.5rem;color:#666;margin-bottom:1rem;">Your cart is empty</h2>
            <p style="color:#888;margin-bottom:2rem;">Add some beautiful handicrafts to your cart!</p>
            <a href="handicrafts.html" class="hero-button">Continue Shopping</a>
          </div>
        </section>
      </main>

      <!-- Footer -->
      <footer class="footer">
        <nav class="footer-links">
          <a href="about.html">About</a>
          <a href="contact.html">Contact</a>
          <a href="privacy-policy.html">Privacy Policy</a>
          <a href="terms.html">Terms of Service</a>
        </nav>
        <p class="footer-text">@2024 Crafts of Bengal. All rights reserved.</p>
      </footer>
    </div>
  </div>

  <!-- Cart Item Template -->
  <template id="cartItemTemplate">
    <div class="cart-item" data-id="">
      <img class="cart-item-image" src="" alt="" />
      <div class="cart-item-details">
        <h3 class="cart-item-name"></h3>
        <div class="cart-item-price"></div>
        <div class="cart-item-controls">
          <button class="quantity-btn minus" onclick="updateQuantity(this, -1)">-</button>
          <span class="quantity">1</span>
          <button class="quantity-btn plus" onclick="updateQuantity(this, 1)">+</button>
          <button class="remove-btn" onclick="removeItem(this)">Remove</button>
        </div>
      </div>
      <div class="cart-item-total"></div>
    </div>
  </template>

  <script src="assets/js/main.js" defer></script>
  <script>
    // Cart functionality
    let cart = {
      items: [],
      summary: {
        subtotal: 0,
        shipping: 0,
        tax: 0,
        total: 0
      }
    };

    // Load cart on page load
    document.addEventListener('DOMContentLoaded', function() {
      // Check if user is logged in
      const isLoggedIn = localStorage.getItem('is_logged_in') === 'true';
      
      if (!isLoggedIn) {
        // Show login message
        document.getElementById('emptyCartMessage').innerHTML = `
          <h2 style="font-size:1.5rem;color:#666;margin-bottom:1rem;">Please login to view your cart</h2>
          <p style="color:#888;margin-bottom:2rem;">You need to be logged in to access your shopping cart.</p>
          <a href="login.html?redirect=cart.html" class="hero-button">Login</a>
        `;
        document.getElementById('emptyCartMessage').style.display = 'block';
        document.getElementById('cartContent').style.display = 'none';
      } else {
        // Load cart
        loadCart();
      }
    });

    function loadCart() {
      // Show loading
      document.getElementById('cartItems').innerHTML = '<div class="cart-loading">Loading cart items...</div>';
      
      fetch('api/cart.php')
        .then(response => {
          if (!response.ok) {
            if (response.status === 401) {
              // Unauthorized, redirect to login
              window.location.href = 'login.html?redirect=cart.html';
              throw new Error('Please login to view your cart');
            }
            throw new Error('Network response was not ok');
          }
          return response.json();
        })
        .then(data => {
          if (data.status === 'success') {
            cart.items = data.data.items;
            cart.summary = data.data.summary;
            updateCartDisplay();
          } else {
            showNotification(data.message || 'Failed to load cart', 'error');
            document.getElementById('cartItems').innerHTML = '<div class="cart-loading">Error loading cart items</div>';
          }
        })
        .catch(error => {
          console.error('Error loading cart:', error);
          document.getElementById('cartItems').innerHTML = '<div class="cart-loading">Error loading cart items</div>';
        });
    }

    function updateCartDisplay() {
      const cartItems = document.getElementById('cartItems');
      const emptyCartMessage = document.getElementById('emptyCartMessage');
      const cartContent = document.getElementById('cartContent');
      const checkoutButton = document.getElementById('checkoutButton');
      
      if (!cart.items || cart.items.length === 0) {
        emptyCartMessage.style.display = 'block';
        cartContent.style.display = 'none';
        checkoutButton.disabled = true;
        return;
      }

      emptyCartMessage.style.display = 'none';
      cartContent.style.display = 'flex';
      checkoutButton.disabled = false;

      // Clear existing items
      cartItems.innerHTML = '';

      // Add items using template
      const template = document.getElementById('cartItemTemplate');
      cart.items.forEach(item => {
        const clone = template.content.cloneNode(true);
        
        // Set item data
        const cartItem = clone.querySelector('.cart-item');
        cartItem.dataset.id = item.id;
        
        const img = clone.querySelector('.cart-item-image');
        img.src = item.image;
        img.alt = item.name;
        
        clone.querySelector('.cart-item-name').textContent = item.name;
        clone.querySelector('.cart-item-price').textContent = `৳${item.price.toLocaleString()}`;
        clone.querySelector('.quantity').textContent = item.quantity;
        clone.querySelector('.cart-item-total').textContent = `৳${(item.price * item.quantity).toLocaleString()}`;
        
        cartItems.appendChild(clone);
      });

      // Update summary
      document.getElementById('subtotal').textContent = `৳${cart.summary.subtotal.toLocaleString()}`;
      document.getElementById('shipping').textContent = `৳${cart.summary.shipping.toLocaleString()}`;
      document.getElementById('tax').textContent = `৳${cart.summary.tax.toLocaleString()}`;
      document.getElementById('total').textContent = `৳${cart.summary.total.toLocaleString()}`;
    }

    function updateQuantity(button, change) {
      const cartItem = button.closest('.cart-item');
      const itemId = cartItem.dataset.id;
      const quantitySpan = cartItem.querySelector('.quantity');
      const currentQuantity = parseInt(quantitySpan.textContent);
      const newQuantity = currentQuantity + change;

      if (newQuantity <= 0) {
        removeItem(button);
        return;
      }

      // Show loading state
      button.disabled = true;
      
      fetch('api/cart.php', {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          cart_item_id: itemId,
          quantity: newQuantity
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          loadCart(); // Reload cart to get updated totals
          showNotification('Cart updated', 'success');
        } else {
          showNotification(data.message || 'Failed to update quantity', 'error');
          button.disabled = false;
        }
      })
      .catch(error => {
        console.error('Error updating quantity:', error);
        showNotification('Failed to update quantity. Please try again.', 'error');
        button.disabled = false;
      });
    }

    function removeItem(button) {
      const cartItem = button.closest('.cart-item');
      const itemId = cartItem.dataset.id;
      
      // Show loading state
      button.disabled = true;
      button.textContent = 'Removing...';

      fetch(`api/cart.php?id=${itemId}`, {
        method: 'DELETE'
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          // Show animation before removing
          cartItem.style.opacity = '0';
          cartItem.style.transform = 'translateX(20px)';
          cartItem.style.transition = 'all 0.3s ease';
          
          setTimeout(() => {
            loadCart(); // Reload cart to get updated totals
            showNotification('Item removed from cart', 'success');
          }, 300);
        } else {
          showNotification(data.message || 'Failed to remove item', 'error');
          button.disabled = false;
          button.textContent = 'Remove';
        }
      })
      .catch(error => {
        console.error('Error removing item:', error);
        showNotification('Failed to remove item. Please try again.', 'error');
        button.disabled = false;
        button.textContent = 'Remove';
      });
    }

    function proceedToCheckout() {
      // Check if user is logged in
      const isLoggedIn = localStorage.getItem('is_logged_in') === 'true';
      
      if (!isLoggedIn) {
        showNotification('Please log in to continue to checkout', 'info');
        setTimeout(() => {
          window.location.href = 'login.html?redirect=cart.html';
        }, 1500);
        return;
      }

      // Proceed to checkout
      window.location.href = 'payment.html';
    }
    
    // Show notification function
    function showNotification(message, type = 'info') {
      // Create notification element if it doesn't exist
      let notification = document.getElementById('notification');
      if (!notification) {
        notification = document.createElement('div');
        notification.id = 'notification';
        notification.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          padding: 12px 20px;
          border-radius: 4px;
          color: white;
          font-weight: 500;
          z-index: 1000;
          opacity: 0;
          transform: translateY(-20px);
          transition: all 0.3s ease;
        `;
        document.body.appendChild(notification);
      }
      
      // Set notification type
      switch (type) {
        case 'success':
          notification.style.backgroundColor = '#28a745';
          break;
        case 'error':
          notification.style.backgroundColor = '#dc3545';
          break;
        case 'info':
          notification.style.backgroundColor = '#17a2b8';
          break;
        default:
          notification.style.backgroundColor = '#343a40';
      }
      
      // Set message and show notification
      notification.textContent = message;
      notification.style.opacity = '1';
      notification.style.transform = 'translateY(0)';
      
      // Hide after 3 seconds
      setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transform = 'translateY(-20px)';
      }, 3000);
    }
  </script>
</body>
</html>